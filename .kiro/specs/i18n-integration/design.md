# Design Document

## Overview

The i18n integration provides comprehensive internationalization support using Paraglide JS, enabling the application to support multiple languages (English, Traditional Chinese, Japanese) with type-safe message access, automatic language detection, and proper pluralization. This design integrates seamlessly with the existing DDD architecture and Svelte 5 patterns.

## Architecture

### Integration Points

```
Application
    ↓
Paraglide Vite Plugin (Build Time)
    ↓
Generated TypeScript Messages ($paraglide/messages)
    ↓
Components (Runtime)
    ↓
Translated UI
```

### Directory Structure

```
messages/
├── en.json              # English translations
├── zh-tw.json           # Traditional Chinese translations
└── jp.json              # Japanese translations

project.inlang/
└── settings.json        # Paraglide configuration

src/lib/paraglide/       # Generated by Paraglide
├── messages.ts          # Type-safe message functions
├── runtime.ts           # Runtime utilities
└── index.ts             # Public API

src/lib/core/i18n/       # Custom i18n utilities
├── locale-switcher.ts   # Language switching logic
└── formatters.ts        # Date/number formatters
```

## Components and Interfaces

### Message Structure

#### Message File Format

```json
{
	"$schema": "https://inlang.com/schema/inlang-message-format",
	"hello_world": "Hello, {name}!",
	"todo_count": "You have {count} {count, plural, one {todo} other {todos}}",
	"created_at": "Created {date, date, short}",
	"price": "{amount, number, currency}"
}
```

### Paraglide Configuration

```json
{
	"$schema": "https://inlang.com/schema/project-settings",
	"modules": [
		"https://cdn.jsdelivr.net/npm/@inlang/plugin-message-format@4/dist/index.js",
		"https://cdn.jsdelivr.net/npm/@inlang/plugin-m-function-matcher@2/dist/index.js"
	],
	"plugin.inlang.messageFormat": {
		"pathPattern": "./messages/{locale}.json"
	},
	"baseLocale": "en",
	"locales": ["en", "zh-tw", "jp"]
}
```

### Generated Message API

```typescript
// Generated by Paraglide
export const hello_world: (params: { name: string }) => string;
export const todo_count: (params: { count: number }) => string;
export const created_at: (params: { date: Date }) => string;
export const price: (params: { amount: number }) => string;
```

### Locale Switcher Interface

```typescript
// src/lib/core/i18n/locale-switcher.ts

export interface LocaleInfo {
	code: string;
	name: string;
	nativeName: string;
}

export const availableLocales: LocaleInfo[] = [
	{ code: 'en', name: 'English', nativeName: 'English' },
	{ code: 'zh-tw', name: 'Traditional Chinese', nativeName: '繁體中文' },
	{ code: 'jp', name: 'Japanese', nativeName: '日本語' }
];

export function getCurrentLocale(): string;
export function setLocale(locale: string): void;
export function detectBrowserLocale(): string;
```

### Formatter Interface

```typescript
// src/lib/core/i18n/formatters.ts

export interface DateFormatOptions {
	style?: 'short' | 'medium' | 'long' | 'full';
	includeTime?: boolean;
}

export interface NumberFormatOptions {
	style?: 'decimal' | 'currency' | 'percent';
	currency?: string;
	minimumFractionDigits?: number;
	maximumFractionDigits?: number;
}

export function formatDate(date: Date, locale: string, options?: DateFormatOptions): string;
export function formatNumber(value: number, locale: string, options?: NumberFormatOptions): string;
export function formatRelativeTime(date: Date, locale: string): string;
```

## Data Models

### Message Keys

#### Common UI Messages

```typescript
interface CommonMessages {
	// Actions
	save: string;
	cancel: string;
	delete: string;
	edit: string;
	create: string;
	update: string;
	close: string;
	confirm: string;

	// States
	loading: string;
	success: string;
	error: string;
	warning: string;

	// Navigation
	home: string;
	settings: string;
	profile: string;
	logout: string;
}
```

#### Todo Domain Messages

```typescript
interface TodoMessages {
	// Labels
	todo_title: string;
	add_todo: string;
	edit_todo: string;
	all_todos: string;
	completed_todos: string;
	pending_todos: string;

	// Actions
	mark_complete: string;
	mark_incomplete: string;
	delete_todo: string;

	// Counts
	todo_count: (params: { count: number }) => string;
	completed_count: (params: { count: number }) => string;

	// Validation
	title_required: string;
	title_too_short: string;
	title_too_long: string;
}
```

### Locale State

```typescript
interface LocaleState {
	current: string; // Current locale code
	available: LocaleInfo[]; // Available locales
	isRTL: boolean; // Right-to-left language
}
```

## Correctness Properties

_A property is a characteristic or behavior that should hold true across all valid executions of a system—essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees._

### Property 1: Message Key Consistency

_For any_ message key in the base locale (en), all other locales should have the same key defined.

**Validates: Requirements 9.2**

### Property 2: Parameter Type Safety

_For any_ message with parameters, calling it with incorrect parameter types should result in a TypeScript compile error.

**Validates: Requirements 3.3**

### Property 3: Missing Translation Fallback

_For any_ missing translation in a non-base locale, the system should fall back to the base locale (English) message.

**Validates: Requirements 9.1**

### Property 4: Locale Switching Updates UI

_For any_ locale change, all displayed messages should update to the new locale immediately.

**Validates: Requirements 6.2, 6.3**

### Property 5: Pluralization Correctness

_For any_ count value, the plural form should match the grammatical rules of the current locale.

**Validates: Requirements 7.1, 7.2, 7.3, 7.4**

### Property 6: Date Format Locale Consistency

_For any_ date value, the formatted output should follow the conventions of the current locale.

**Validates: Requirements 8.1**

### Property 7: Number Format Locale Consistency

_For any_ number value, the formatted output should follow the conventions of the current locale.

**Validates: Requirements 8.2**

### Property 8: Build-time Validation

_For any_ message file, the build should fail if it contains invalid syntax or missing required keys.

**Validates: Requirements 10.1, 10.2**

### Property 9: Locale Persistence

_For any_ locale selection, the preference should be persisted and restored on next visit.

**Validates: Requirements 6.4**

### Property 10: Browser Locale Detection

_For any_ first-time visitor, the system should detect and use their browser's preferred language if available.

**Validates: Requirements 6.5**

## Error Handling

### Build-time Errors

- **Invalid JSON**: Fail build with syntax error location
- **Missing Keys**: Fail build with list of missing keys per locale
- **Invalid Parameters**: Fail build with parameter mismatch details
- **Unused Keys**: Warn about unused message keys

### Runtime Errors

- **Missing Translation**: Fall back to base locale, log warning in dev
- **Invalid Locale**: Fall back to base locale, log error
- **Parameter Mismatch**: Use fallback message, log error in dev
- **Format Errors**: Return unformatted value, log error

### Development Warnings

- **Incomplete Translations**: Log missing translations in dev mode
- **Unused Messages**: Warn about unused message keys
- **Deprecated Messages**: Warn about deprecated message usage

## Testing Strategy

### Unit Tests

#### Message Generation Tests

```typescript
// messages.test.ts
describe('Generated Messages', () => {
	it('should have all keys in all locales', () => {
		// Property 1: Message Key Consistency
	});

	it('should enforce parameter types', () => {
		// Property 2: Parameter Type Safety
	});

	it('should handle pluralization correctly', () => {
		// Property 5: Pluralization Correctness
	});
});
```

#### Locale Switcher Tests

```typescript
// locale-switcher.test.ts
describe('Locale Switcher', () => {
	it('should switch locale', () => {
		// Property 4: Locale Switching Updates UI
	});

	it('should persist locale preference', () => {
		// Property 9: Locale Persistence
	});

	it('should detect browser locale', () => {
		// Property 10: Browser Locale Detection
	});
});
```

#### Formatter Tests

```typescript
// formatters.test.ts
describe('Formatters', () => {
	it('should format dates by locale', () => {
		// Property 6: Date Format Locale Consistency
	});

	it('should format numbers by locale', () => {
		// Property 7: Number Format Locale Consistency
	});

	it('should format relative times', () => {
		// Test relative time formatting
	});
});
```

### Integration Tests

#### Component Translation Tests

```typescript
// component-i18n.test.ts
describe('Component Translations', () => {
	it('should display translated text', () => {
		// Test component uses messages correctly
	});

	it('should update on locale change', () => {
		// Test reactive translation updates
	});
});
```

### Build Tests

#### Validation Tests

```typescript
// build-validation.test.ts
describe('Build Validation', () => {
	it('should fail on missing keys', () => {
		// Property 8: Build-time Validation
	});

	it('should fail on invalid syntax', () => {
		// Test JSON validation
	});
});
```

### E2E Tests

```typescript
// i18n.test.ts
test('should switch language and persist', async ({ page }) => {
	await page.goto('/');

	// Switch to Chinese
	await page.selectOption('select[name="locale"]', 'zh-tw');
	await expect(page.locator('h1')).toContainText('待辦事項');

	// Reload page
	await page.reload();

	// Verify locale persisted
	await expect(page.locator('h1')).toContainText('待辦事項');
});
```

## Implementation Notes

### Vite Plugin Configuration

```typescript
// vite.config.ts
import { paraglideVitePlugin } from '@inlang/paraglide-js';

export default defineConfig({
	plugins: [
		paraglideVitePlugin({
			project: './project.inlang',
			outdir: './src/lib/paraglide'
		})
	]
});
```

### Using Messages in Components

```svelte
<script lang="ts">
	import * as m from '$paraglide/messages';

	interface Props {
		name?: string;
		todoCount?: number;
	}

	let { name = 'User', todoCount = 5 }: Props = $props();
</script>

<h1>{m.hello_world({ name })}</h1><p>{m.todo_count({ count: todoCount })}</p>
```

### Locale Switcher Component

```svelte
<script lang="ts">
	import { availableLocales, getCurrentLocale, setLocale } from '$lib/core/i18n/locale-switcher';

	interface Props {
		class?: string;
	}

	let { class: className }: Props = $props();

	let currentLocale = $state(getCurrentLocale());

	function handleLocaleChange(event: Event) {
		const target = event.target as HTMLSelectElement;
		const locale = target.value;
		setLocale(locale);
		currentLocale = locale;
	}
</script>

<!-- ✅ CORRECT: onchange attribute, not on:change -->
<select value={currentLocale} onchange={handleLocaleChange} class={className}>
	{#each availableLocales as locale}
		<option value={locale.code}>{locale.nativeName}</option>
	{/each}
</select>
```

### Date Formatting

```typescript
import { formatDate } from '$lib/core/i18n/formatters';

const date = new Date();
const locale = getCurrentLocale();

// Short format
const short = formatDate(date, locale, { style: 'short' });
// Output (en): "1/15/24"
// Output (zh-tw): "2024/1/15"
// Output (jp): "2024/01/15"

// Long format with time
const long = formatDate(date, locale, { style: 'long', includeTime: true });
// Output (en): "January 15, 2024 at 3:30 PM"
// Output (zh-tw): "2024年1月15日 下午3:30"
// Output (jp): "2024年1月15日 15:30"
```

### Number Formatting

```typescript
import { formatNumber } from '$lib/core/i18n/formatters';

const amount = 1234.56;
const locale = getCurrentLocale();

// Currency
const currency = formatNumber(amount, locale, {
	style: 'currency',
	currency: 'USD'
});
// Output (en): "$1,234.56"
// Output (zh-tw): "US$1,234.56"
// Output (jp): "$1,234.56"

// Percentage
const percent = formatNumber(0.1234, locale, { style: 'percent' });
// Output (en): "12.34%"
// Output (zh-tw): "12.34%"
// Output (jp): "12.34%"
```

## Performance Considerations

### Build-time Optimization

- Messages are compiled to TypeScript at build time
- No runtime parsing of message files
- Tree-shaking removes unused messages
- Type checking happens at compile time

### Runtime Optimization

- Lazy load locale data when switching languages
- Cache formatted dates and numbers
- Minimize re-renders on locale change
- Use memoization for expensive formatting operations

### Bundle Size

- Only include messages for used locales
- Split locale data into separate chunks
- Load locale data on demand
- Compress message files

## Security Considerations

### Input Sanitization

- Sanitize all user-provided parameters in messages
- Escape HTML in translated strings
- Validate locale codes to prevent injection
- Sanitize date/number format options

### XSS Prevention

- Use Svelte's built-in XSS protection
- Don't use {@html} with translated content
- Validate all message parameters
- Escape special characters in translations

### Data Privacy

- Don't include sensitive data in translations
- Don't log user locale preferences without consent
- Respect user privacy settings
- Follow GDPR guidelines for locale storage
